<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChemCheatcode â€¢ Algebra Solver</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2f;
      --panel2:#0c1526;
      --card:#111f3a;
      --text:#eaf1ff;
      --muted:#a8b6d6;
      --muted2:#7e90b8;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);
      --blue:#2d7dff;
      --blue2:#57a0ff;
      --good:#35d07f;
      --warn:#ffcc66;
      --bad:#ff5c77;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius: 16px;
      --radius2: 12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1100px 700px at 20% -10%, rgba(45,125,255,.28), transparent 60%),
                  radial-gradient(900px 650px at 80% 10%, rgba(87,160,255,.14), transparent 55%),
                  linear-gradient(180deg, #071023, #050a15 70%);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .app{display:grid; grid-template-columns:270px 1fr; min-height:100vh;}

    .side{
      border-right:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,26,47,.92), rgba(9,16,30,.92));
      padding:18px 14px;
      position:sticky; top:0; height:100vh;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:12px 12px 14px 12px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(87,160,255,.95), rgba(45,125,255,.35) 60%, rgba(45,125,255,.12) 100%);
      border:1px solid rgba(255,255,255,.14);
      position:relative; overflow:hidden;
    }
    .logo:after{
      content:""; position:absolute; inset:-40%;
      background: conic-gradient(from 180deg, transparent, rgba(255,255,255,.25), transparent 55%);
      animation: spin 5.5s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .brand h1{font-size:14px; margin:0; letter-spacing:.3px}
    .brand p{margin:2px 0 0 0; color:var(--muted2); font-size:12px}

    .nav{margin-top:14px; display:flex; flex-direction:column; gap:8px;}
    .nav a{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid transparent;
      color: var(--muted);
      transition:.15s ease;
    }
    .nav a:hover{background: rgba(255,255,255,.04); color:var(--text); border-color: var(--line)}
    .nav a.active{
      background: linear-gradient(90deg, rgba(45,125,255,.25), rgba(45,125,255,.06));
      border-color: rgba(45,125,255,.35);
      color: var(--text);
    }
    .nav .dot{
      width:10px; height:10px; border-radius:100px;
      background: rgba(168,182,214,.35);
      box-shadow: 0 0 0 3px rgba(168,182,214,.12);
    }
    .nav a.active .dot{
      background: var(--blue2);
      box-shadow: 0 0 0 3px rgba(87,160,255,.18);
    }
    .side .hint{
      margin-top:14px;
      padding:12px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .kbd{
      font-family:var(--mono);
      font-size:11px;
      padding:1px 6px;
      border:1px solid var(--line2);
      border-bottom-color: rgba(255,255,255,.26);
      border-radius: 8px;
      background: rgba(0,0,0,.20);
      color: var(--text);
      display:inline-block;
      margin:0 2px;
    }

    .main{ padding: 18px 18px 28px 18px; }
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding: 14px 16px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:5;
      backdrop-filter: blur(10px);
    }
    .title{display:flex; flex-direction:column; gap:2px;}
    .title h2{margin:0; font-size:16px; letter-spacing:.2px}
    .title span{color:var(--muted2); font-size:12px}
    .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .search{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      min-width: 280px;
    }
    .search input{width:100%; border:none; outline:none; background:transparent; color:var(--text); font-size:13px;}
    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size:13px;
    }
    select, button, input{ font-family:inherit; }
    select{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding:9px 10px;
      border-radius: 12px;
      outline:none;
      font-size:13px;
    }
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:9px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s ease;
      font-size:13px;
      user-select:none;
    }
    button:hover{border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.06)}
    button.bad{
      border-color: rgba(255,92,119,.35);
      background: rgba(255,92,119,.10);
    }

    .grid{margin-top:16px; display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px;}
    .card{
      grid-column: span 12;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(17,31,58,.80), rgba(10,18,34,.78));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 16px;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    .cardHead .meta{display:flex; flex-direction:column; gap:4px; min-width:220px;}
    .cardHead .meta h3{margin:0; font-size:15px; letter-spacing:.2px; display:flex; align-items:center; gap:10px;}
    .tag{
      font-size:11px;
      padding:2px 8px;
      border-radius: 999px;
      border:1px solid rgba(45,125,255,.35);
      color: rgba(230,240,255,.9);
      background: rgba(45,125,255,.12);
    }
    .cardHead .meta p{margin:0; color:var(--muted2); font-size:12px; line-height:1.35}
    .cardHead .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .seg{
      display:flex;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 12px;
      overflow:hidden;
    }
    .seg button{
      border:none; border-right:1px solid var(--line);
      border-radius: 0;
      padding:9px 10px;
      background: transparent;
      color: var(--muted);
      cursor:pointer;
    }
    .seg button:last-child{border-right:none}
    .seg button.active{background: rgba(45,125,255,.20); color: var(--text);}

    .body{
      padding: 14px 16px 16px 16px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .app{grid-template-columns:1fr}
      .side{position:relative; height:auto}
      .body{grid-template-columns:1fr}
      .search{min-width: 0; width: 100%}
      .controls{width:100%}
      .topbar{top:0}
    }

    .inputs{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(0,0,0,.14);
      padding: 12px;
    }
    .inputs .row{display:grid; grid-template-columns: 1fr 1fr; gap: 10px;}
    @media (max-width: 620px){ .inputs .row{grid-template-columns:1fr;} }

    .field{display:flex; flex-direction:column; gap:6px;}
    .field label{
      font-size:12px; color: var(--muted);
      display:flex; justify-content:space-between; gap:10px; align-items:center;
    }
    .field label .u{color:var(--muted2); font-family:var(--mono); font-size:11px}
    .field input{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:10px 10px;
      border-radius: 12px;
      outline:none;
      font-size:13px;
      font-family: var(--mono);
    }
    .field input:focus{border-color: rgba(87,160,255,.55)}
    .field input:disabled{opacity:.55; cursor:not-allowed;}

    .output{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(0,0,0,.14);
      padding: 12px;
      display:flex; flex-direction:column; gap:10px;
    }
    .big{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      padding: 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(45,125,255,.16), rgba(0,0,0,.14));
    }
    .big .lhs{display:flex; flex-direction:column; gap:4px}
    .big .lhs .k{color:var(--muted2); font-size:12px}
    .big .lhs .v{font-family: var(--mono); font-size: 18px; letter-spacing: .2px; word-break: break-word;}
    .status{
      font-size:12px;
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      color: var(--muted);
      background: rgba(255,255,255,.03);
      line-height:1.35;
    }
    .status.good{border-color: rgba(53,208,127,.35); background: rgba(53,208,127,.10); color: rgba(216,255,234,.92)}
    .status.bad{border-color: rgba(255,92,119,.40); background: rgba(255,92,119,.10); color: rgba(255,220,226,.92)}
    .status.warn{border-color: rgba(255,204,102,.40); background: rgba(255,204,102,.10); color: rgba(255,242,216,.92)}

    details{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.02);
      overflow:hidden;
      margin-top:10px;
    }
    details summary{
      cursor:pointer;
      padding: 10px 12px;
      list-style:none;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      color: var(--muted);
      user-select:none;
    }
    details summary::-webkit-details-marker{display:none}
    details .inside{padding: 10px 12px 12px 12px; border-top:1px solid var(--line)}
    .eq{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.02);
      padding: 10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-family: var(--mono);
      font-size: 12.5px;
      color: rgba(234,241,255,.92);
    }
    .eq .pretty{white-space:nowrap; overflow:auto}
    .eq button{padding:7px 10px; border-radius: 10px; font-size:12px;}
    .forms{display:flex; flex-direction:column; gap:8px;}
    .footerNote{
      margin-top:14px;
      color: var(--muted2);
      font-size:12px;
      line-height:1.5;
      padding: 12px 14px;
      border:1px dashed rgba(255,255,255,.16);
      border-radius: var(--radius);
      background: rgba(0,0,0,.14);
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="side">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>ChemCheatcode</h1>
          <p>Algebra Solver</p>
        </div>
      </div>

      <nav class="nav" aria-label="Site navigation">
        <a href="index.html">
          <span class="dot" aria-hidden="true"></span>
          <span>Converters</span>
        </a>
        <a class="active" href="algebra.html?v=1">
          <span class="dot" aria-hidden="true"></span>
          <span>Formula Solver</span>
        </a>
        <a href="thermo.html?v=1">
          <span class="dot" aria-hidden="true"></span>
          <span>Thermo</span>
        </a>
      </nav>

      <div class="hint">
        <div style="margin-bottom:8px; font-weight:600; color:rgba(234,241,255,.92);">Input tips</div>
        Type values with units (or just numbers):
        <div style="margin-top:8px">
          <span class="kbd">25 C</span>
          <span class="kbd">298 K</span>
          <span class="kbd">760 mmHg</span>
          <span class="kbd">101.3 kPa</span>
          <span class="kbd">250 mL</span>
          <span class="kbd">3.0 L</span>
        </div>
        <div style="margin-top:10px">Bare numbers default to the cardâ€™s base units (atm, L, mol, K, etc.).</div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="title">
          <h2>Formula Solver</h2>
          <span>Select a formula card â†’ choose what to solve for â†’ enter values â†’ get the rearranged equation + answer.</span>
        </div>
        <div class="controls">
          <div class="search" role="search" aria-label="Search formulas">
            <span style="opacity:.8">ðŸ”Ž</span>
            <input id="searchInput" type="text" placeholder="Search (e.g., gas, dilution, dalton, q=mcÎ”T)" />
          </div>
          <div class="pill" title="Significant figures setting">
            <span style="opacity:.9">Sig figs</span>
            <select id="sigSelect" aria-label="Significant figures">
              <option value="3" selected>3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>
          </div>
          <button id="resetAll" class="bad" type="button">Reset all</button>
        </div>
      </header>

      <section class="grid" id="cards"></section>

      <div class="footerNote">
        <b>Note:</b> Choose a target variable, then fill in the other fields.
        Units are optional (defaults to the cardâ€™s base units).
      </div>
    </main>
  </div>

  <script>
    /**********************
     * Units + parsing
     **********************/
    function toBase(kind, value, unitRaw){
      const u = (unitRaw || "").trim().toLowerCase().replaceAll("Â°","").replaceAll(" ", "");
      const v = value;
      const bad = () => ({ ok:false, msg:`Unsupported unit "${unitRaw}"` });

      if(kind === "unitless" || kind === "epsilon"){ return { ok:true, val:v, unit:unitRaw||"" }; }

      if(kind === "pressure"){
        if(!u || u==="atm") return { ok:true, val:v, unit:"atm" };
        if(u==="kpa") return { ok:true, val:v/101.325, unit:"atm" };
        if(u==="pa")  return { ok:true, val:v/101325, unit:"atm" };
        if(u==="mmhg" || u==="torr") return { ok:true, val:v/760, unit:"atm" };
        return bad();
      }
      if(kind === "volume"){
        if(!u || u==="l" || u==="lt" || u==="liter" || u==="liters") return { ok:true, val:v, unit:"L" };
        if(u==="ml" || u==="milliliter" || u==="milliliters") return { ok:true, val:v/1000, unit:"L" };
        return bad();
      }
      if(kind === "amount"){
        if(!u || u==="mol") return { ok:true, val:v, unit:"mol" };
        if(u==="mmol") return { ok:true, val:v/1000, unit:"mol" };
        return bad();
      }
      if(kind === "temp"){
        if(!u || u==="k") return { ok:true, val:v, unit:"K" };
        if(u==="c" || u==="degc" || u==="celsius") return { ok:true, val:v + 273.15, unit:"K", note:"converted from Â°C to K" };
        return bad();
      }
      if(kind === "molarity"){
        if(!u || u==="m" || u==="mol/l" || u==="molperliter") return { ok:true, val:v, unit:"M" };
        if(u==="mm" || u==="mmolar" || u==="mmol/l") return { ok:true, val:v/1000, unit:"M" };
        return bad();
      }
      return bad();
    }

    function fromBase(kind, value, outUnitRaw){
      const u = (outUnitRaw || "").trim().toLowerCase().replaceAll("Â°","").replaceAll(" ", "");
      const v = value;

      if(kind === "unitless" || kind === "epsilon") return { ok:true, val:v, unit:outUnitRaw||"" };

      if(kind === "pressure"){
        if(!u || u==="atm") return { ok:true, val:v, unit:"atm" };
        if(u==="kpa") return { ok:true, val:v*101.325, unit:"kPa" };
        if(u==="mmhg" || u==="torr") return { ok:true, val:v*760, unit:"mmHg" };
        return { ok:false, msg:`Unsupported output unit "${outUnitRaw}"` };
      }
      if(kind === "volume"){
        if(!u || u==="l") return { ok:true, val:v, unit:"L" };
        if(u==="ml") return { ok:true, val:v*1000, unit:"mL" };
        return { ok:false, msg:`Unsupported output unit "${outUnitRaw}"` };
      }
      if(kind === "amount"){
        if(!u || u==="mol") return { ok:true, val:v, unit:"mol" };
        if(u==="mmol") return { ok:true, val:v*1000, unit:"mmol" };
        return { ok:false, msg:`Unsupported output unit "${outUnitRaw}"` };
      }
      if(kind === "temp"){
        if(!u || u==="k") return { ok:true, val:v, unit:"K" };
        if(u==="c") return { ok:true, val:v - 273.15, unit:"Â°C" };
        return { ok:false, msg:`Unsupported output unit "${outUnitRaw}"` };
      }
      if(kind === "molarity"){
        if(!u || u==="m") return { ok:true, val:v, unit:"M" };
        if(u==="mm") return { ok:true, val:v*1000, unit:"mM" };
        return { ok:false, msg:`Unsupported output unit "${outUnitRaw}"` };
      }
      return { ok:false, msg:`Unsupported output unit "${outUnitRaw}"` };
    }

    function parseNumberAndUnit(raw){
      const s = (raw ?? "").toString().trim();
      if(!s) return { ok:false, msg:"Empty" };
      const cleaned = s.replaceAll(",", "").trim();
      const m = cleaned.match(/^([+-]?(?:\d+(?:\.\d*)?|\.\d+)(?:e[+-]?\d+)?)\s*([a-zA-ZÂ°Âµ\/\.\-\^\*\(\)]+)?$/);
      if(!m) return { ok:false, msg:"Could not parse" };
      const num = Number(m[1]);
      if(!Number.isFinite(num)) return { ok:false, msg:"Not a valid number" };
      const unit = (m[2] || "").trim();
      return { ok:true, num, unit };
    }

    function sigFormat(x, sig){
      if(!Number.isFinite(x)) return "â€”";
      if(x === 0) return "0";
      const s = Number(sig || 3);
      return Number(x).toPrecision(s).replace(/(?:\.0+|(\.\d+?)0+)$/, "$1");
    }
    function clampNice(x){ return Object.is(x, -0) ? 0 : x; }

    /**********************
     * Formula library
     **********************/
    const R_ATM_DEFAULT = 0.082057; // LÂ·atm/(molÂ·K)
    const formulas = [
      {
        id:"ideal_gas",
        title:"Ideal Gas Law",
        tag:"Gas Laws",
        desc:"PV = nRT (base: atm, L, mol, K).",
        variables: [
          { key:"P", label:"Pressure (P)", kind:"pressure", baseUnit:"atm", outUnits:["atm","kPa","mmHg"] },
          { key:"V", label:"Volume (V)", kind:"volume", baseUnit:"L", outUnits:["L","mL"] },
          { key:"n", label:"Moles (n)", kind:"amount", baseUnit:"mol", outUnits:["mol","mmol"] },
          { key:"T", label:"Temperature (T)", kind:"temp", baseUnit:"K", outUnits:["K","Â°C"] }
        ],
        solveFor:["P","V","n","T"],
        constants:[ { key:"R", label:"Gas constant (R)", default: R_ATM_DEFAULT, note:"LÂ·atm/(molÂ·K)" } ],
        forms:[
          { solveFor:"P", pretty:"P = (nRT)/V", calc:(x)=> (x.n*x.R*x.T)/x.V, outKind:"pressure" },
          { solveFor:"V", pretty:"V = (nRT)/P", calc:(x)=> (x.n*x.R*x.T)/x.P, outKind:"volume" },
          { solveFor:"n", pretty:"n = (PV)/(RT)", calc:(x)=> (x.P*x.V)/(x.R*x.T), outKind:"amount" },
          { solveFor:"T", pretty:"T = (PV)/(nR)", calc:(x)=> (x.P*x.V)/(x.n*x.R), outKind:"temp" }
        ]
      },

      {
        id:"boyles",
        title:"Boyleâ€™s Law",
        tag:"Gas Laws",
        desc:"Pâ‚Vâ‚ = Pâ‚‚Vâ‚‚ (T and n constant).",
        variables: [
          { key:"P1", label:"Pâ‚", kind:"pressure", baseUnit:"atm", outUnits:["atm","kPa","mmHg"] },
          { key:"V1", label:"Vâ‚", kind:"volume", baseUnit:"L", outUnits:["L","mL"] },
          { key:"P2", label:"Pâ‚‚", kind:"pressure", baseUnit:"atm", outUnits:["atm","kPa","mmHg"] },
          { key:"V2", label:"Vâ‚‚", kind:"volume", baseUnit:"L", outUnits:["L","mL"] }
        ],
        solveFor:["P2","V2","P1","V1"],
        forms:[
          { solveFor:"P2", pretty:"Pâ‚‚ = (Pâ‚Vâ‚)/Vâ‚‚", calc:(x)=> (x.P1*x.V1)/x.V2, outKind:"pressure" },
          { solveFor:"V2", pretty:"Vâ‚‚ = (Pâ‚Vâ‚)/Pâ‚‚", calc:(x)=> (x.P1*x.V1)/x.P2, outKind:"volume" },
          { solveFor:"P1", pretty:"Pâ‚ = (Pâ‚‚Vâ‚‚)/Vâ‚", calc:(x)=> (x.P2*x.V2)/x.V1, outKind:"pressure" },
          { solveFor:"V1", pretty:"Vâ‚ = (Pâ‚‚Vâ‚‚)/Pâ‚", calc:(x)=> (x.P2*x.V2)/x.P1, outKind:"volume" }
        ]
      },

      {
        id:"amontons",
        title:"Amontonsâ€™s Law (Pâ€“T)",
        tag:"Gas Laws",
        desc:"Pâ‚/Tâ‚ = Pâ‚‚/Tâ‚‚ (V and n constant).",
        variables: [
          { key:"P1", label:"Pâ‚", kind:"pressure", baseUnit:"atm", outUnits:["atm","kPa","mmHg"] },
          { key:"T1", label:"Tâ‚", kind:"temp", baseUnit:"K", outUnits:["K","Â°C"] },
          { key:"P2", label:"Pâ‚‚", kind:"pressure", baseUnit:"atm", outUnits:["atm","kPa","mmHg"] },
          { key:"T2", label:"Tâ‚‚", kind:"temp", baseUnit:"K", outUnits:["K","Â°C"] }
        ],
        solveFor:["P2","T2","P1","T1"],
        forms:[
          { solveFor:"P2", pretty:"Pâ‚‚ = Pâ‚(Tâ‚‚/Tâ‚)", calc:(x)=> x.P1*(x.T2/x.T1), outKind:"pressure" },
          { solveFor:"T2", pretty:"Tâ‚‚ = Tâ‚(Pâ‚‚/Pâ‚)", calc:(x)=> x.T1*(x.P2/x.P1), outKind:"temp" },
          { solveFor:"P1", pretty:"Pâ‚ = Pâ‚‚(Tâ‚/Tâ‚‚)", calc:(x)=> x.P2*(x.T1/x.T2), outKind:"pressure" },
          { solveFor:"T1", pretty:"Tâ‚ = Tâ‚‚(Pâ‚/Pâ‚‚)", calc:(x)=> x.T2*(x.P1/x.P2), outKind:"temp" }
        ]
      },

      {
        id:"avogadro",
        title:"Avogadroâ€™s Law",
        tag:"Gas Laws",
        desc:"Vâ‚/nâ‚ = Vâ‚‚/nâ‚‚ (P and T constant).",
        variables: [
          { key:"V1", label:"Vâ‚", kind:"volume", baseUnit:"L", outUnits:["L","mL"] },
          { key:"n1", label:"nâ‚", kind:"amount", baseUnit:"mol", outUnits:["mol","mmol"] },
          { key:"V2", label:"Vâ‚‚", kind:"volume", baseUnit:"L", outUnits:["L","mL"] },
          { key:"n2", label:"nâ‚‚", kind:"amount", baseUnit:"mol", outUnits:["mol","mmol"] }
        ],
        solveFor:["V2","n2","V1","n1"],
        forms:[
          { solveFor:"V2", pretty:"Vâ‚‚ = Vâ‚(nâ‚‚/nâ‚)", calc:(x)=> x.V1*(x.n2/x.n1), outKind:"volume" },
          { solveFor:"n2", pretty:"nâ‚‚ = nâ‚(Vâ‚‚/Vâ‚)", calc:(x)=> x.n1*(x.V2/x.V1), outKind:"amount" },
          { solveFor:"V1", pretty:"Vâ‚ = Vâ‚‚(nâ‚/nâ‚‚)", calc:(x)=> x.V2*(x.n1/x.n2), outKind:"volume" },
          { solveFor:"n1", pretty:"nâ‚ = nâ‚‚(Vâ‚/Vâ‚‚)", calc:(x)=> x.n2*(x.V1/x.V2), outKind:"amount" }
        ]
      },

      {
        id:"combined_gas",
        title:"Combined Gas Law",
        tag:"Gas Laws",
        desc:"(Pâ‚Vâ‚)/Tâ‚ = (Pâ‚‚Vâ‚‚)/Tâ‚‚ (use K for temps).",
        variables: [
          { key:"P1", label:"Pâ‚", kind:"pressure", baseUnit:"atm", outUnits:["atm","kPa","mmHg"] },
          { key:"V1", label:"Vâ‚", kind:"volume", baseUnit:"L", outUnits:["L","mL"] },
          { key:"T1", label:"Tâ‚", kind:"temp", baseUnit:"K", outUnits:["K","Â°C"] },
          { key:"P2", label:"Pâ‚‚", kind:"pressure", baseUnit:"atm", outUnits:["atm","kPa","mmHg"] },
          { key:"V2", label:"Vâ‚‚", kind:"volume", baseUnit:"L", outUnits:["L","mL"] },
          { key:"T2", label:"Tâ‚‚", kind:"temp", baseUnit:"K", outUnits:["K","Â°C"] }
        ],
        solveFor:["P2","V2","T2","P1","V1","T1"],
        forms:[
          { solveFor:"P2", pretty:"Pâ‚‚ = (Pâ‚Vâ‚Tâ‚‚)/(Tâ‚Vâ‚‚)", calc:(x)=> (x.P1*x.V1*x.T2)/(x.T1*x.V2), outKind:"pressure" },
          { solveFor:"V2", pretty:"Vâ‚‚ = (Pâ‚Vâ‚Tâ‚‚)/(Tâ‚Pâ‚‚)", calc:(x)=> (x.P1*x.V1*x.T2)/(x.T1*x.P2), outKind:"volume" },
          { solveFor:"T2", pretty:"Tâ‚‚ = (Pâ‚‚Vâ‚‚Tâ‚)/(Pâ‚Vâ‚)", calc:(x)=> (x.P2*x.V2*x.T1)/(x.P1*x.V1), outKind:"temp" },
          { solveFor:"P1", pretty:"Pâ‚ = (Pâ‚‚Vâ‚‚Tâ‚)/(Tâ‚‚Vâ‚)", calc:(x)=> (x.P2*x.V2*x.T1)/(x.T2*x.V1), outKind:"pressure" },
          { solveFor:"V1", pretty:"Vâ‚ = (Pâ‚‚Vâ‚‚Tâ‚)/(Tâ‚‚Pâ‚)", calc:(x)=> (x.P2*x.V2*x.T1)/(x.T2*x.P1), outKind:"volume" },
          { solveFor:"T1", pretty:"Tâ‚ = (Pâ‚Vâ‚Tâ‚‚)/(Pâ‚‚Vâ‚‚)", calc:(x)=> (x.P1*x.V1*x.T2)/(x.P2*x.V2), outKind:"temp" }
        ]
      },

      {
        id:"dilution",
        title:"Dilution",
        tag:"Solutions",
        desc:"Mâ‚Vâ‚ = Mâ‚‚Vâ‚‚ (base: M, L).",
        variables:[
          { key:"M1", label:"Mâ‚ (initial molarity)", kind:"molarity", baseUnit:"M", outUnits:["M","mM"] },
          { key:"V1", label:"Vâ‚ (initial volume)", kind:"volume", baseUnit:"L", outUnits:["L","mL"] },
          { key:"M2", label:"Mâ‚‚ (final molarity)", kind:"molarity", baseUnit:"M", outUnits:["M","mM"] },
          { key:"V2", label:"Vâ‚‚ (final volume)", kind:"volume", baseUnit:"L", outUnits:["L","mL"] }
        ],
        solveFor:["M1","V1","M2","V2"],
        forms:[
          { solveFor:"M2", pretty:"Mâ‚‚ = (Mâ‚Vâ‚)/Vâ‚‚", calc:(x)=> (x.M1*x.V1)/x.V2, outKind:"molarity" },
          { solveFor:"V2", pretty:"Vâ‚‚ = (Mâ‚Vâ‚)/Mâ‚‚", calc:(x)=> (x.M1*x.V1)/x.M2, outKind:"volume" },
          { solveFor:"M1", pretty:"Mâ‚ = (Mâ‚‚Vâ‚‚)/Vâ‚", calc:(x)=> (x.M2*x.V2)/x.V1, outKind:"molarity" },
          { solveFor:"V1", pretty:"Vâ‚ = (Mâ‚‚Vâ‚‚)/Mâ‚", calc:(x)=> (x.M2*x.V2)/x.M1, outKind:"volume" }
        ]
      }
    ];

    /**********************
     * UI build
     **********************/
    const $cards = document.getElementById("cards");
    const $search = document.getElementById("searchInput");
    const $sig = document.getElementById("sigSelect");
    const $reset = document.getElementById("resetAll");

    function esc(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function makeFieldHTML(f, idx, fid){
      return `
        <div class="field">
          <label for="${fid}">
            <span class="lblLeft">${esc(f.label)} <span class="u">${esc(f.baseUnit || "")}</span></span>
          </label>
          <input id="${fid}" data-k="${esc(f.key)}" data-kind="${esc(f.kind)}" data-baseunit="${esc(f.baseUnit||"")}" inputmode="decimal" placeholder="${esc(f.baseUnit||"")}" />
        </div>
      `;
    }

    function buildCard(formula){
      const segBtns = formula.solveFor.map((k,i)=>`<button type="button" class="${i===0?"active":""}" data-target="${esc(k)}">${esc(k)}</button>`).join("");
      const leftFields = formula.variables.map((v,i)=>makeFieldHTML(v,i, `${formula.id}__${v.key}`)).join("");

      const constHTML = (formula.constants && formula.constants.length)
        ? `<details open>
            <summary><span>Constants</span><span style="opacity:.7">â–¼</span></summary>
            <div class="inside">
              ${formula.constants.map(c=>`
                <div class="field" style="margin-top:8px">
                  <label><span class="lblLeft">${esc(c.label)} <span class="u">${esc(c.note||"")}</span></span></label>
                  <input data-const="${esc(c.key)}" value="${esc(c.default)}" inputmode="decimal" />
                </div>
              `).join("")}
            </div>
          </details>`
        : "";

      return `
        <article class="card" data-id="${esc(formula.id)}" data-title="${esc(formula.title)}" data-tag="${esc(formula.tag)}">
          <div class="cardHead">
            <div class="meta">
              <h3>${esc(formula.title)} <span class="tag">${esc(formula.tag)}</span></h3>
              <p>${esc(formula.desc)}</p>
            </div>
            <div class="actions">
              <div class="seg" role="tablist" aria-label="Solve for">
                ${segBtns}
              </div>
            </div>
          </div>

          <div class="body">
            <div>
              <div class="inputs">
                <div class="row">
                  ${leftFields}
                </div>
                ${constHTML}
              </div>
            </div>

            <div class="output">
              <div class="big">
                <div class="lhs">
                  <div class="k">Answer</div>
                  <div class="v" data-out>â€”</div>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button type="button" data-calc>Calculate</button>
                  <button type="button" data-clear class="bad">Clear</button>
                </div>
              </div>

              <div class="status" data-status>Choose a target, fill other fields, then Calculate.</div>

              <details>
                <summary><span>All rearrangements</span><span style="opacity:.7">â–¼</span></summary>
                <div class="inside forms">
                  ${formula.forms.map(f=>`
                    <div class="eq">
                      <div class="pretty">${esc(f.pretty)}</div>
                      <button type="button" class="mini" data-copy="${esc(f.pretty)}">Copy</button>
                    </div>
                  `).join("")}
                </div>
              </details>
            </div>
          </div>
        </article>
      `;
    }

    function render(list){
      $cards.innerHTML = list.map(buildCard).join("");
      wireAll();
    }

    function getTarget(card){
      const btn = card.querySelector(".seg button.active");
      return btn ? btn.getAttribute("data-target") : null;
    }

    function setTarget(card, key){
      card.querySelectorAll(".seg button").forEach(b=>{
        b.classList.toggle("active", b.getAttribute("data-target") === key);
      });
      compute(card, true);
    }

    function readValue(field){
      const key = field.getAttribute("data-k");
      const kind = field.getAttribute("data-kind");
      const baseUnit = field.getAttribute("data-baseunit") || "";
      const raw = field.value.trim();
      if(!raw) return { ok:false, key, kind, msg:"Missing" };
      const p = parseNumberAndUnit(raw);
      if(!p.ok) return { ok:false, key, kind, msg:p.msg };
      const tb = toBase(kind, p.num, p.unit || baseUnit);
      if(!tb.ok) return { ok:false, key, kind, msg:tb.msg };
      return { ok:true, key, kind, val:tb.val };
    }

    function compute(card, quiet){
      const id = card.getAttribute("data-id");
      const formula = formulas.find(f=>f.id===id);
      const target = getTarget(card);

      const status = card.querySelector("[data-status]");
      const out = card.querySelector("[data-out]");
      const sig = Number($sig.value || 3);

      if(!formula || !target){
        if(!quiet) status.textContent = "Missing formula/target.";
        return;
      }

      // build x object
      const x = {};
      // constants
      (formula.constants || []).forEach(c=>{
        const inp = card.querySelector(`[data-const="${c.key}"]`);
        const num = Number((inp?.value ?? c.default));
        x[c.key] = Number.isFinite(num) ? num : c.default;
      });

      // variables
      const vars = formula.variables;
      const results = [];
      vars.forEach(v=>{
        const field = card.querySelector(`#${CSS.escape(formula.id+"__"+v.key)}`);
        if(!field) return;
        if(v.key === target) return;
        if(v.key === target) return;

        const rv = readValue(field);
        if(!rv.ok){
          results.push(rv);
        }else{
          x[v.key] = rv.val;
        }
      });

      // Ensure all required (non-target) vars exist
      const needed = formula.variables
        .map(v=>v.key)
        .filter(k=>k !== target);

      const missing = needed.filter(k => !(k in x));
      if(missing.length){
        out.textContent = "â€”";
        status.className = "status warn";
        status.textContent = `Missing: ${missing.join(", ")} (enter those to solve for ${target}).`;
        return;
      }

      // Find selected rearrangement
      const form = (formula.forms || []).find(fr => fr.solveFor === target);
      if(!form){
        out.textContent = "â€”";
        status.className = "status bad";
        status.textContent = `No rearrangement found for ${target}.`;
        return;
      }

      // Compute
      let ans;
      try{
        ans = form.calc(x);
      }catch(e){
        out.textContent = "â€”";
        status.className = "status bad";
        status.textContent = `Calculation failed: ${(e && e.message) ? e.message : "error"}`;
        return;
      }

      if(!Number.isFinite(ans)){
        out.textContent = "â€”";
        status.className = "status bad";
        status.textContent = "Result is not finite (check for divide-by-zero or missing values).";
        return;
      }

      ans = clampNice(ans);

      // Output unit + formatting
      const targetVar = formula.variables.find(v=>v.key===target);
      const unit = targetVar?.baseUnit || "";
      out.textContent = `${sigFormat(ans, sig)} ${unit}`.trim();

      status.className = "status good";
      status.textContent = `Using: ${form.pretty}`;
    }

    function clearCard(card){
      card.querySelectorAll("input[data-k]").forEach(inp=> inp.value = "");
      card.querySelectorAll("[data-out]").forEach(o=> o.textContent = "â€”");
      const st = card.querySelector("[data-status]");
      if(st){
        st.className = "status";
        st.textContent = "Choose a target, fill other fields, then Calculate.";
      }
    }

    function copyText(t){
      const text = (t ?? "").toString();
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).catch(()=>{});
      }else{
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); }catch(e){}
        ta.remove();
      }
    }

    function wireAll(){
      document.querySelectorAll(".card").forEach(card=>{
        // Solve-for segment buttons
        card.querySelectorAll(".seg button").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            setTarget(card, btn.getAttribute("data-target"));
          });
        });

        // Calculate
        const calcBtn = card.querySelector("[data-calc]");
        if(calcBtn){
          calcBtn.addEventListener("click", ()=> compute(card, false));
        }

        // Clear
        const clrBtn = card.querySelector("[data-clear]");
        if(clrBtn){
          clrBtn.addEventListener("click", ()=> clearCard(card));
        }

        // Inputs: Enter triggers calculate; typing updates (quiet)
        card.querySelectorAll("input[data-k]").forEach(inp=>{
          inp.addEventListener("keydown", (e)=>{
            if(e.key === "Enter"){
              e.preventDefault();
              compute(card, false);
            }
          });
          inp.addEventListener("input", ()=> compute(card, true));
        });

        // Constants: typing updates (quiet)
        card.querySelectorAll("input[data-const]").forEach(inp=>{
          inp.addEventListener("input", ()=> compute(card, true));
          inp.addEventListener("keydown", (e)=>{
            if(e.key === "Enter"){
              e.preventDefault();
              compute(card, false);
            }
          });
        });

        // Copy equation
        card.querySelectorAll("[data-copy]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const eq = btn.getAttribute("data-copy") || "";
            copyText(eq);
            btn.textContent = "Copied";
            setTimeout(()=> btn.textContent = "Copy", 900);
          });
        });
      });
    }

    function filterFormulas(q){
      const s = (q ?? "").toString().trim().toLowerCase();
      if(!s) return formulas;
      return formulas.filter(f=>{
        const hay = `${f.title} ${f.tag} ${f.desc}`.toLowerCase();
        return hay.includes(s);
      });
    }

    // Search + global controls
    $search.addEventListener("input", ()=>{
      render(filterFormulas($search.value));
    });

    $sig.addEventListener("change", ()=>{
      // Recompute all cards quietly with new sig figs
      document.querySelectorAll(".card").forEach(card=> compute(card, true));
    });

    $reset.addEventListener("click", ()=>{
      // reset search
      $search.value = "";
      render(formulas);
      // clear all
      document.querySelectorAll(".card").forEach(card=> clearCard(card));
    });

    // Initial render
    render(formulas);
  </script>
</body>
</html>
