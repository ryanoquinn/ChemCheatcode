<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChemCheatcode • Converters</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);
      --accent: #4da3ff;
      --accent2:#66ffc7;
      --danger:#ff6b6b;
      --ok:#74f28a;
      --shadow: 0 24px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(77,163,255,.18), transparent 60%),
        radial-gradient(900px 700px at 85% 30%, rgba(102,255,199,.12), transparent 55%),
        radial-gradient(1000px 800px at 55% 95%, rgba(160,120,255,.10), transparent 60%),
        linear-gradient(180deg, #070a14 0%, #0b1020 50%, #060912 100%);
      display:flex;
      align-items:stretch;
    }

    .wrap{
      width:min(1300px, 100%);
      margin: 0 auto;
      padding: 22px 18px 40px;
    }

    /* ===== Top Navigation ===== */
    .topNav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 12px;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 220px;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg, rgba(77,163,255,.95), rgba(102,255,199,.55));
      box-shadow: 0 0 0 5px rgba(77,163,255,.10);
      border: 1px solid rgba(255,255,255,.12);
    }
    .brandText{display:flex; flex-direction:column; gap:2px; line-height:1.1;}
    .brandText b{font-size:13px; letter-spacing:.2px;}
    .brandText span{font-size:12px; color: var(--muted2);}

    .tabs{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .tab{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-weight:700;
      letter-spacing:.2px;
      transition: border-color .15s ease, background .15s ease, transform .05s ease;
      user-select:none;
      text-decoration:none;
    }
    .tab:hover{border-color: rgba(77,163,255,.55); background: rgba(77,163,255,.10);}
    .tab:active{ transform: translateY(1px); }
    .tab.active{
      border-color: rgba(77,163,255,.65);
      color: rgba(255,255,255,.92);
      background: linear-gradient(135deg, rgba(77,163,255,.25), rgba(102,255,199,.14));
    }
    .tabDot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }
    .tab.active .tabDot{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 5px rgba(77,163,255,.10);
    }
    @media (max-width: 720px){
      .topNav{flex-direction:column; align-items:stretch;}
      .tabs{justify-content:flex-start;}
    }

    /* ===== Layout ===== */
    .layout{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr;}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08) 0%, rgba(255,255,255,.05) 100%);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .cardHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 16px 16px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .cardHead h2{
      margin:0;
      font-size: 15px;
      letter-spacing:.2px;
      color: rgba(255,255,255,.88);
    }
    .cardHead .sub{
      margin-top:6px;
      font-size:12px;
      color: var(--muted2);
      line-height:1.35;
    }
    .cardBody{padding: 14px 16px 16px;}

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .badge.ok{ border-color: rgba(116,242,138,.35); color: rgba(116,242,138,.92); }
    .badge.bad{ border-color: rgba(255,107,107,.35); color: rgba(255,107,107,.92); }
    .badge.warn{ border-color: rgba(255,210,130,.35); color: rgba(255,210,130,.95); }

    .toolSearch{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
      font-family: var(--mono);
      transition: border-color .15s ease, box-shadow .15s ease;
      margin-bottom: 10px;
    }
    .toolSearch:focus{
      border-color: rgba(77,163,255,.65);
      box-shadow: 0 0 0 4px rgba(77,163,255,.18);
    }

    .toolBtn{
      width:100%;
      text-align:left;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      transition: border-color .15s ease, background .15s ease, transform .05s ease;
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin-bottom: 8px;
    }
    .toolBtn:hover{
      border-color: rgba(77,163,255,.55);
      background: rgba(77,163,255,.10);
    }
    .toolBtn:active{ transform: translateY(1px); }
    .toolBtn.active{
      border-color: rgba(77,163,255,.65);
      background: linear-gradient(135deg, rgba(77,163,255,.22), rgba(102,255,199,.12));
    }
    .toolBtn .k{font-weight:800; font-size:12px; letter-spacing:.2px;}
    .toolBtn .d{font-size:12px; color: var(--muted2); margin-top:4px; line-height:1.3;}
    .miniDot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
      margin-top: 3px;
      flex: 0 0 auto;
    }
    .toolBtn.active .miniDot{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 5px rgba(77,163,255,.10);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid2{grid-template-columns: 1fr;}
    }

    .row2{display:grid; grid-template-columns: 1fr 1fr; gap: 12px;}
    @media (max-width: 720px){
      .row2{grid-template-columns: 1fr;}
    }

    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;}
    @media (max-width: 980px){
      .row3{grid-template-columns: 1fr;}
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted2);
      margin: 0 0 6px;
      letter-spacing:.2px;
    }
    input[type="text"], select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease;
      font-family: var(--mono);
      letter-spacing:.1px;
    }
    input[type="text"]:focus, select:focus{
      border-color: rgba(77,163,255,.65);
      box-shadow: 0 0 0 4px rgba(77,163,255,.18);
    }
    select{
      appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.65) 50%),
        linear-gradient(135deg, rgba(255,255,255,.65) 50%, transparent 50%),
        linear-gradient(to right, rgba(255,255,255,.0), rgba(255,255,255,.0));
      background-position:
        calc(100% - 18px) calc(50% - 3px),
        calc(100% - 12px) calc(50% - 3px),
        0 0;
      background-size: 6px 6px, 6px 6px, 100% 100%;
      background-repeat:no-repeat;
      padding-right: 36px;
      font-family: var(--sans);
    }

    .btn{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.20);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      transition: transform .06s ease, border-color .15s ease, background .15s ease;
      user-select:none;
      font-weight: 700;
      letter-spacing:.2px;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .btn:hover{
      border-color: rgba(77,163,255,.55);
      background: rgba(77,163,255,.10);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(77,163,255,.65);
      background: linear-gradient(135deg, rgba(77,163,255,.25), rgba(102,255,199,.18));
    }
    .btn.danger{
      border-color: rgba(255,107,107,.55);
      background: linear-gradient(135deg, rgba(255,107,107,.20), rgba(255,107,107,.10));
    }

    .resultBox{
      display:grid;
      gap: 10px;
      margin-top: 12px;
      padding: 12px;
      background: rgba(0,0,0,.18);
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 16px;
    }
    .big{
      font-family: var(--mono);
      font-size: clamp(18px, 2.8vw, 26px);
      line-height:1.1;
      letter-spacing: .3px;
      word-break: break-word;
    }
    .steps{
      margin:0;
      white-space: pre-wrap;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.86);
      line-height: 1.5;
    }
    .footerNote{
      margin-top: 12px;
      color: var(--muted2);
      font-size: 12px;
      line-height:1.35;
    }

    .kbd{
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.86);
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topNav" role="navigation" aria-label="ChemCheatcode navigation">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandText">
          <b>ChemCheatcode</b>
          <span>Converters & Formula Tools</span>
        </div>
      </div>

      <div class="tabs" aria-label="Pages">
        <a class="tab active" href="index.html">
          <span class="tabDot" aria-hidden="true"></span>
          <span>Converters</span>
        </a>
        <a class="tab" href="algebra.html?v=1">
          <span class="tabDot" aria-hidden="true"></span>
          <span>Formula Solver</span>
        </a>
        <a class="tab" href="thermo.html?v=1">
          <span class="tabDot" aria-hidden="true"></span>
          <span>Thermo</span>
        </a>
      </div>
    </div>

    <div class="layout">
      <!-- Sidebar -->
      <aside class="card" aria-label="Tools">
        <div class="cardHead">
          <div>
            <h2>Tools</h2>
            <div class="sub">Unit conversions used across Gen Chem → P-Chem.</div>
          </div>
          <span class="badge" id="statusBadge">Ready</span>
        </div>

        <div class="cardBody">
          <input id="toolSearch" class="toolSearch" type="text" placeholder="Search tools..." aria-label="Search tools" />

          <button class="toolBtn active" data-tool="uniconv" type="button">
            <span class="miniDot" aria-hidden="true"></span>
            <div>
              <div class="k">Universal Chem Converter</div>
              <div class="d">Convert between common chemistry units + sig figs.</div>
            </div>
          </button>

          <div class="footerNote">
            <b>Quick tips:</b> type values like <span class="kbd">101.3 kPa</span>, <span class="kbd">1.25 atm</span>,
            <span class="kbd">25 C</span>, <span class="kbd">2.50e3 J</span>, <span class="kbd">0.075 L</span>.
          </div>
        </div>
      </aside>

      <!-- Main -->
      <main class="grid2">
        <section class="card" aria-label="Inputs">
          <div class="cardHead">
            <div>
              <h2 id="toolTitle">Universal Chem Converter</h2>
              <div class="sub" id="toolSub">Pick a category, pick units, enter a value, choose sig figs, then Solve.</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn danger" id="btnReset" type="button">Reset</button>
              <button class="btn primary" id="btnSolve" type="button">Solve</button>
            </div>
          </div>
          <div class="cardBody" id="inputsArea"></div>
        </section>

        <section class="card" aria-label="Output">
          <div class="cardHead">
            <div>
              <h2>Answer + Steps</h2>
              <div class="sub">Shows factor method / key constants used.</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn" id="btnDemo" type="button">Demo</button>
              <button class="btn" id="btnCopy" type="button">Copy</button>
            </div>
          </div>
          <div class="cardBody">
            <div class="resultBox" role="region" aria-label="Result">
              <div class="big" id="ansBig">—</div>
              <div class="footerNote" id="ansNote">Pick units and solve.</div>
              <pre class="steps" id="stepsOut">Enter a value and choose units, then hit Solve.</pre>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    /***********************
     * Safe DOM helpers
     ***********************/
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));

    function formatSig(x, sig){
      if (!isFinite(x)) return "NaN";
      if (x === 0) return "0";
      const abs = Math.abs(x);
      const exp = Math.floor(Math.log10(abs));
      const decimals = Math.max(0, sig - 1 - exp);
      if (abs >= 1e6 || abs < 1e-3){
        return x.toExponential(sig-1).replace("+","").replace("e","E");
      }
      return x.toFixed(decimals).replace(/\.?0+$/,"");
    }

    function setBadge(kind, text){
      const el = $("#statusBadge");
      if (!el) return;
      el.className = "badge" + (kind ? " " + kind : "");
      el.textContent = text;
    }

    /***********************
     * Conversion library
     ***********************/
    const CONST = {
      atm_to_Pa: 101325,
      bar_to_Pa: 1e5,
      torr_to_Pa: 101325/760,
      L_to_m3: 1e-3,
      cal_to_J: 4.184,
      eV_to_J: 1.602176634e-19,
      R_J: 8.31446261815324,
      NA: 6.02214076e23
    };

    const CATS = {
      length: {
        label: "Length",
        base: "m",
        units: {
          m:   {label:"m",  toBase:v=>v, fromBase:v=>v},
          cm:  {label:"cm", toBase:v=>v/100, fromBase:v=>v*100},
          mm:  {label:"mm", toBase:v=>v/1000, fromBase:v=>v*1000},
          um:  {label:"µm", toBase:v=>v/1e6, fromBase:v=>v*1e6},
          nm:  {label:"nm", toBase:v=>v/1e9, fromBase:v=>v*1e9},
          A:   {label:"Å",  toBase:v=>v*1e-10, fromBase:v=>v/1e-10},
          km:  {label:"km", toBase:v=>v*1000, fromBase:v=>v/1000},
          in:  {label:"in", toBase:v=>v*0.0254, fromBase:v=>v/0.0254},
          ft:  {label:"ft", toBase:v=>v*0.3048, fromBase:v=>v/0.3048}
        }
      },
      mass: {
        label: "Mass",
        base: "g",
        units: {
          g:  {label:"g",  toBase:v=>v, fromBase:v=>v},
          kg: {label:"kg", toBase:v=>v*1000, fromBase:v=>v/1000},
          mg: {label:"mg", toBase:v=>v/1000, fromBase:v=>v*1000},
          ug: {label:"µg", toBase:v=>v/1e6, fromBase:v=>v*1e6},
          lb: {label:"lb", toBase:v=>v*453.59237, fromBase:v=>v/453.59237}
        }
      },
      volume: {
        label: "Volume",
        base: "L",
        units: {
          L:   {label:"L",   toBase:v=>v, fromBase:v=>v},
          mL:  {label:"mL",  toBase:v=>v/1000, fromBase:v=>v*1000},
          uL:  {label:"µL",  toBase:v=>v/1e6, fromBase:v=>v*1e6},
          cm3: {label:"cm³", toBase:v=>v/1000, fromBase:v=>v*1000},
          m3:  {label:"m³",  toBase:v=>v/CONST.L_to_m3, fromBase:v=>v*CONST.L_to_m3}
        }
      },
      temperature: {
        label: "Temperature",
        base: "K",
        units: {
          K: {label:"K",  toBase:v=>v, fromBase:v=>v},
          C: {label:"°C", toBase:v=>v+273.15, fromBase:v=>v-273.15},
          F: {label:"°F", toBase:v=>(v-32)*5/9 + 273.15, fromBase:v=>(v-273.15)*9/5 + 32}
        }
      },
      pressure: {
        label: "Pressure",
        base: "Pa",
        units: {
          Pa:   {label:"Pa",   toBase:v=>v, fromBase:v=>v},
          kPa:  {label:"kPa",  toBase:v=>v*1000, fromBase:v=>v/1000},
          atm:  {label:"atm",  toBase:v=>v*CONST.atm_to_Pa, fromBase:v=>v/CONST.atm_to_Pa},
          bar:  {label:"bar",  toBase:v=>v*CONST.bar_to_Pa, fromBase:v=>v/CONST.bar_to_Pa},
          torr: {label:"torr", toBase:v=>v*CONST.torr_to_Pa, fromBase:v=>v/CONST.torr_to_Pa},
          mmHg: {label:"mmHg", toBase:v=>v*CONST.torr_to_Pa, fromBase:v=>v/CONST.torr_to_Pa}
        }
      },
      energy: {
        label: "Energy",
        base: "J",
        units: {
          J:   {label:"J",   toBase:v=>v, fromBase:v=>v},
          kJ:  {label:"kJ",  toBase:v=>v*1000, fromBase:v=>v/1000},
          cal: {label:"cal", toBase:v=>v*CONST.cal_to_J, fromBase:v=>v/CONST.cal_to_J},
          kcal:{label:"kcal",toBase:v=>v*1000*CONST.cal_to_J, fromBase:v=>v/(1000*CONST.cal_to_J)},
          eV:  {label:"eV",  toBase:v=>v*CONST.eV_to_J, fromBase:v=>v/CONST.eV_to_J}
        }
      },
      amount: {
        label: "Amount (n)",
        base: "mol",
        units: {
          mol: {label:"mol",      toBase:v=>v, fromBase:v=>v},
          mmol:{label:"mmol",     toBase:v=>v/1000, fromBase:v=>v*1000},
          umol:{label:"µmol",     toBase:v=>v/1e6, fromBase:v=>v*1e6},
          particles:{label:"particles", toBase:v=>v/CONST.NA, fromBase:v=>v*CONST.NA}
        }
      },
      concentration: {
        label: "Concentration",
        base: "mol/L",
        units: {
          M:   {label:"M (mol/L)", toBase:v=>v, fromBase:v=>v},
          mM:  {label:"mM",        toBase:v=>v/1000, fromBase:v=>v*1000},
          uM:  {label:"µM",        toBase:v=>v/1e6, fromBase:v=>v*1e6},
          nM:  {label:"nM",        toBase:v=>v/1e9, fromBase:v=>v*1e9}
        }
      },
      density: {
        label: "Density",
        base: "g/mL",
        units: {
          g_mL: {label:"g/mL", toBase:v=>v, fromBase:v=>v},
          g_L:  {label:"g/L",  toBase:v=>v/1000, fromBase:v=>v*1000},
          kg_m3:{label:"kg/m³",toBase:v=>v/1000, fromBase:v=>v*1000}
        }
      }
    };

    const catKeys = Object.keys(CATS);

    /***********************
     * UI build
     ***********************/
    const state = {
      cat: "pressure",
      from: "atm",
      to: "kPa",
      sig: 3,
      valueRaw: ""
    };

    function buildConverterUI(){
      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <div class="row3">
          <div>
            <label for="catPick">Category</label>
            <select id="catPick"></select>
            <div class="hint footerNote" style="margin-top:6px">Pick the type of unit you’re converting.</div>
          </div>

          <div>
            <label for="sigPick">Sig figs</label>
            <select id="sigPick">
              <option value="2">2</option>
              <option value="3" selected>3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>
            <div class="hint footerNote" style="margin-top:6px">Answer rounds to this many significant figures.</div>
          </div>

          <div>
            <label for="valIn">Value</label>
            <input id="valIn" type="text" placeholder="e.g., 1.25" />
            <div class="hint footerNote" style="margin-top:6px">Type just the number (units picked below).</div>
          </div>
        </div>

        <div class="row2" style="margin-top:12px">
          <div>
            <label for="fromPick">From</label>
            <select id="fromPick"></select>
          </div>

          <div>
            <label for="toPick">To</label>
            <select id="toPick"></select>
          </div>
        </div>

        <div class="footerNote">
          Common categories in chem: pressure, temperature, energy, amount, concentration (M), density.
        </div>
      `;
      return wrap;
    }

    const inputsArea = $("#inputsArea");

    function clearAnswer(){
      const ansBig = $("#ansBig");
      const ansNote = $("#ansNote");
      const stepsOut = $("#stepsOut");
      if (ansBig) ansBig.textContent = "—";
      if (ansNote) ansNote.textContent = "Pick units and solve.";
      if (stepsOut) stepsOut.textContent = "Enter a value and choose units, then hit Solve.";
      setBadge("", "Ready");
    }

    function render(){
      if (!inputsArea) return;

      inputsArea.innerHTML = "";
      const ui = buildConverterUI();
      inputsArea.appendChild(ui);

      const catPick = $("#catPick");
      const fromPick = $("#fromPick");
      const toPick = $("#toPick");
      const sigPick = $("#sigPick");
      const valIn = $("#valIn");

      if (!catPick || !fromPick || !toPick || !sigPick || !valIn) return;

      catPick.innerHTML = "";
      catKeys.forEach(k=>{
        const o=document.createElement("option");
        o.value=k;
        o.textContent=CATS[k].label;
        catPick.appendChild(o);
      });
      catPick.value = state.cat;
      sigPick.value = String(state.sig);

      function fillUnits(){
        const cat = CATS[state.cat];
        const uKeys = Object.keys(cat.units);

        fromPick.innerHTML = "";
        toPick.innerHTML = "";

        uKeys.forEach(uk=>{
          const u = cat.units[uk];
          const o1=document.createElement("option");
          o1.value=uk; o1.textContent=u.label;
          fromPick.appendChild(o1);

          const o2=document.createElement("option");
          o2.value=uk; o2.textContent=u.label;
          toPick.appendChild(o2);
        });

        if (!cat.units[state.from]) state.from = uKeys[0];
        if (!cat.units[state.to]) state.to = uKeys[1] || uKeys[0];

        fromPick.value = state.from;
        toPick.value = state.to;
      }

      fillUnits();
      valIn.value = state.valueRaw;

      catPick.addEventListener("change", ()=>{
        state.cat = catPick.value;
        const keys = Object.keys(CATS[state.cat].units);
        state.from = keys[0];
        state.to = keys[1] || keys[0];
        render();
        clearAnswer();
      });

      fromPick.addEventListener("change", ()=>{ state.from = fromPick.value; clearAnswer(); });
      toPick.addEventListener("change", ()=>{ state.to = toPick.value; clearAnswer(); });
      sigPick.addEventListener("change", ()=>{ state.sig = Number(sigPick.value); clearAnswer(); });

      valIn.addEventListener("input", ()=>{ state.valueRaw = valIn.value; });
    }

    function solve(){
      const ansBig = $("#ansBig");
      const ansNote = $("#ansNote");
      const stepsOut = $("#stepsOut");

      const value = Number(String(state.valueRaw || "").trim());
      if (!isFinite(value)){
        setBadge("bad", "Enter a number");
        if (ansBig) ansBig.textContent = "—";
        if (ansNote) ansNote.textContent = "Could not parse the input number.";
        if (stepsOut) stepsOut.textContent = "Example: 1.25  (don’t type units in this field; choose from dropdowns)";
        return;
      }

      const cat = CATS[state.cat];
      const fromU = cat.units[state.from];
      const toU = cat.units[state.to];

      if (!fromU || !toU){
        setBadge("bad", "Bad units");
        if (ansBig) ansBig.textContent = "—";
        if (ansNote) ansNote.textContent = "Unit selection error.";
        if (stepsOut) stepsOut.textContent = "Pick units again.";
        return;
      }

      const base = fromU.toBase(value);
      const out = toU.fromBase(base);

      const outStr = formatSig(out, state.sig);
      if (ansBig) ansBig.textContent = `${outStr} ${toU.label}`;
      if (ansNote) ansNote.textContent = `(${state.sig} sig figs)`;
      setBadge("ok", "Solved");

      const steps = [];
      steps.push(`Category: ${cat.label}`);
      steps.push(`Convert: ${value} ${fromU.label} → ${toU.label}`);
      steps.push("");
      steps.push(`Step 1) Convert to base (${cat.base})`);
      steps.push(`  base = ${fromU.label} → ${cat.base}`);
      steps.push(`  base = ${formatSig(base, Math.max(6, state.sig))} ${cat.base}`);
      steps.push("");
      steps.push(`Step 2) Convert base → target`);
      steps.push(`  out = ${formatSig(out, Math.max(6, state.sig))} ${toU.label}`);
      steps.push("");

      if (state.cat === "pressure"){
        steps.push(`Constants used: 1 atm = ${CONST.atm_to_Pa} Pa, 1 bar = ${CONST.bar_to_Pa} Pa, 760 torr = 1 atm`);
      } else if (state.cat === "volume"){
        steps.push(`Constant used: 1 L = 1e−3 m³`);
      } else if (state.cat === "energy"){
        steps.push(`Constants used: 1 cal = 4.184 J, 1 eV = 1.602176634×10⁻¹⁹ J`);
      } else if (state.cat === "amount"){
        steps.push(`Constant used: N_A = 6.02214076×10²³ particles/mol`);
      } else if (state.cat === "temperature"){
        steps.push(`Formulas: K = °C + 273.15 ; K = (°F − 32)·5/9 + 273.15`);
      }

      if (stepsOut) stepsOut.textContent = steps.join("\n");
    }

    // Wire buttons safely
    const btnSolve = $("#btnSolve");
    const btnReset = $("#btnReset");
    const btnCopy = $("#btnCopy");
    const btnDemo = $("#btnDemo");

    if (btnSolve) btnSolve.addEventListener("click", solve);

    if (btnReset) btnReset.addEventListener("click", ()=>{
      state.cat = "pressure";
      state.from = "atm";
      state.to = "kPa";
      state.sig = 3;
      state.valueRaw = "";
      render();
      clearAnswer();
    });

    if (btnCopy) btnCopy.addEventListener("click", async ()=>{
      const ansBig = $("#ansBig")?.textContent || "";
      const ansNote = $("#ansNote")?.textContent || "";
      const steps = $("#stepsOut")?.textContent || "";
      const txt = `${ansBig}\n${ansNote}\n\n${steps}`.trim();
      if (!txt || txt.startsWith("—")) return;
      try{
        await navigator.clipboard.writeText(txt);
        setBadge("ok", "Copied!");
        setTimeout(()=>setBadge("", "Ready"), 900);
      }catch{
        setBadge("bad", "Copy failed");
      }
    });

    if (btnDemo) btnDemo.addEventListener("click", ()=>{
      state.cat = "pressure";
      state.from = "atm";
      state.to = "kPa";
      state.sig = 3;
      state.valueRaw = "1.25";
      render();
      clearAnswer();
      solve();
    });

    // Tool search: guard in case the element is missing in any future edits
    const toolSearch = $("#toolSearch");
    if (toolSearch){
      toolSearch.addEventListener("input", (e)=>{
        const q = String(e.target.value||"").toLowerCase().trim();
        $$(".toolBtn").forEach(b=>{
          const text=(b.innerText||"").toLowerCase();
          b.style.display = (!q || text.includes(q)) ? "" : "none";
        });
      });
    }

    // Tool button active state
    $$(".toolBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        $$(".toolBtn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        clearAnswer();
      });
    });

    render();
    clearAnswer();
  </script>
</body>
</html>
